<script>
    // Configuration
    const GEOSERVER_URL = 'http://localhost:8080/geoserver/nlcd/wms';
    const LAYER_NAME = 'nlcd:nlcd';
    let currentYear = 2000;
    let isPlaying = false;
    let playInterval;
    let playSpeed = 1000;

    // Create WMS layer
    function createWMSLayer(year) {
        return new ol.layer.Tile({
            source: new ol.source.TileWMS({
                url: GEOSERVER_URL,
                params: {
                    'LAYERS': LAYER_NAME,
                    'TILED': true,
                    'TIME': `${year}-01-01T00:00:00.000Z`,
                    'VERSION': '1.3.0'
                },
                serverType: 'geoserver',
                transition: 0
            })
        });
    }

    // Initialize map with Satellite basemap
    const wmsLayer = createWMSLayer(currentYear);

    // ðŸŒŽ Satellite imagery (ESRI World Imagery)
    const satelliteLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
            url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            attributions: 'Tiles Â© Esri'
        })
    });

    const map = new ol.Map({
        target: 'map',
        layers: [
            satelliteLayer,   // Satellite basemap
            wmsLayer          // NLCD WMS layer
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([-115.16, 36.11]),
            zoom: 9
        })
    });

    // Update year
    function updateYear(year) {
        currentYear = year;
        document.getElementById('year-text').textContent = year;
        document.getElementById('year-slider').value = year;
        
        wmsLayer.getSource().updateParams({
            'TIME': `${year}-01-01T00:00:00.000Z`
        });
    }

    // Play functionality
    function startPlaying() {
        if (isPlaying) return;
        isPlaying = true;
        document.getElementById('play-btn').disabled = true;
        document.getElementById('pause-btn').disabled = false;
        
        playInterval = setInterval(() => {
            if (currentYear < 2024) {
                updateYear(currentYear + 1);
            } else {
                updateYear(2000);
            }
        }, playSpeed);
    }

    function stopPlaying() {
        isPlaying = false;
        clearInterval(playInterval);
        document.getElementById('play-btn').disabled = false;
        document.getElementById('pause-btn').disabled = true;
    }

    // Event listeners
    document.getElementById('year-slider').addEventListener('input', (e) => {
        stopPlaying();
        updateYear(parseInt(e.target.value));
    });

    document.getElementById('first-btn').addEventListener('click', () => {
        stopPlaying();
        updateYear(2000);
    });

    document.getElementById('prev-btn').addEventListener('click', () => {
        stopPlaying();
        if (currentYear > 2000) updateYear(currentYear - 1);
    });

    document.getElementById('play-btn').addEventListener('click', startPlaying);
    document.getElementById('pause-btn').addEventListener('click', stopPlaying);

    document.getElementById('next-btn').addEventListener('click', () => {
        stopPlaying();
        if (currentYear < 2024) updateYear(currentYear + 1);
    });

    document.getElementById('last-btn').addEventListener('click', () => {
        stopPlaying();
        updateYear(2024);
    });

    document.getElementById('speed-select').addEventListener('change', (e) => {
        playSpeed = parseInt(e.target.value);
        if (isPlaying) {
            stopPlaying();
            startPlaying();
        }
    });

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
        if (e.key === ' ') {
            e.preventDefault();
            if (isPlaying) stopPlaying();
            else startPlaying();
        } else if (e.key === 'ArrowLeft') {
            stopPlaying();
            if (currentYear > 2000) updateYear(currentYear - 1);
        } else if (e.key === 'ArrowRight') {
            stopPlaying();
            if (currentYear < 2024) updateYear(currentYear + 1);
        }
    });
</script>
